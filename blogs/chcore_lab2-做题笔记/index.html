<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="简介 文档链接：Lab2: 内存管理 - IPADS OS Course Lab Manual\n本实验主要目的在于让同学们熟悉内核启动过程中对内存的初始化和内核启动后对物理内存和页表的管理，包括三个部分。\n">
<title>ChCore_lab2 做题笔记</title>

<link rel='canonical' href='http://localhost:1313/blogs/chcore_lab2-%E5%81%9A%E9%A2%98%E7%AC%94%E8%AE%B0/'>

<link rel="stylesheet" href="/scss/style.min.663803bebe609202d5b39d848f2d7c2dc8b598a2d879efa079fa88893d29c49c.css"><meta property='og:title' content="ChCore_lab2 做题笔记">
<meta property='og:description' content="简介 文档链接：Lab2: 内存管理 - IPADS OS Course Lab Manual\n本实验主要目的在于让同学们熟悉内核启动过程中对内存的初始化和内核启动后对物理内存和页表的管理，包括三个部分。\n">
<meta property='og:url' content='http://localhost:1313/blogs/chcore_lab2-%E5%81%9A%E9%A2%98%E7%AC%94%E8%AE%B0/'>
<meta property='og:site_name' content='Jacko John&#39;s Blog'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:published_time' content='2024-11-24T16:26:44&#43;08:00'/><meta property='article:modified_time' content='2024-11-24T16:26:44&#43;08:00'/>
<meta name="twitter:title" content="ChCore_lab2 做题笔记">
<meta name="twitter:description" content="简介 文档链接：Lab2: 内存管理 - IPADS OS Course Lab Manual\n本实验主要目的在于让同学们熟悉内核启动过程中对内存的初始化和内核启动后对物理内存和页表的管理，包括三个部分。\n">
    <link rel="shortcut icon" href="/favicon.ico" />

    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="切换菜单">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu10569844772362567299.jpg" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">♾️</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">Jacko John&#39;s Blog</a></h1>
            <h2 class="site-description">Welcome to my blog! I write about programming, tech, and other stuff.</h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='https://github.com/Jacko-John'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg t="1727712067746" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="6130" width="256" height="256"><path d="M512 0c-282.76736 0-512 229.23264-512 512s229.23264 512 512 512 512-229.23264 512-512-229.23264-512-512-512zM816.04608 816.04608c-39.5264 39.50592-85.504 70.53312-136.704 92.18048-13.0048 5.50912-26.2144 10.32192-39.60832 14.49984l0-76.73856c0-40.32512-13.824-70.00064-41.49248-89.00608 17.32608-1.65888 33.25952-3.9936 47.75936-7.00416s29.83936-7.33184 45.99808-13.0048 30.65856-12.41088 43.49952-20.25472 25.16992-18.00192 37.00736-30.49472 21.74976-26.66496 29.75744-42.496 14.336-34.83648 19.00544-56.99584 7.00416-46.592 7.00416-73.25696c0-51.67104-16.83456-95.66208-50.50368-131.9936 15.33952-39.99744 13.66016-83.49696-4.99712-130.49856l-12.4928-1.49504c-8.66304-1.00352-24.24832 2.6624-46.75584 10.99776s-47.75936 21.99552-75.75552 41.00096c-39.66976-10.99776-80.83456-16.50688-123.4944-16.50688-43.008 0-84.00896 5.50912-123.00288 16.50688-17.67424-12.00128-34.4064-21.9136-50.25792-29.75744s-28.50816-13.16864-37.9904-15.99488-18.3296-4.58752-26.50112-5.24288-13.4144-0.83968-15.74912-0.49152-3.9936 0.67584-4.99712 1.00352c-18.65728 47.32928-20.33664 90.8288-4.99712 130.49856-33.66912 36.33152-50.50368 80.34304-50.50368 131.9936 0 26.66496 2.33472 51.07712 7.00416 73.25696s10.99776 41.1648 19.00544 56.99584 17.92 30.0032 29.75744 42.496 24.1664 22.67136 37.00736 30.49472 27.3408 14.58176 43.49952 20.25472 31.49824 9.99424 45.99808 13.0048 30.4128 5.3248 47.75936 7.00416c-27.3408 18.65728-41.00096 48.3328-41.00096 89.00608l0 78.2336c-15.09376-4.48512-29.98272-9.80992-44.60544-15.99488-51.2-21.64736-97.19808-52.67456-136.704-92.18048s-70.53312-85.504-92.18048-136.704c-22.40512-52.96128-33.75104-109.2608-33.75104-167.34208s11.3664-114.3808 33.75104-167.34208c21.64736-51.2 52.67456-97.19808 92.18048-136.704s85.504-70.53312 136.704-92.18048c52.96128-22.40512 109.2608-33.75104 167.34208-33.75104s114.3808 11.3664 167.34208 33.75104c51.2 21.64736 97.19808 52.67456 136.704 92.18048s70.53312 85.504 92.18048 136.704c22.40512 52.96128 33.75104 109.2608 33.75104 167.34208s-11.3664 114.3808-33.75104 167.34208c-21.64736 51.2-52.67456 97.19808-92.18048 136.704z" fill="#515151" p-id="6131"></path></svg>
                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>Home</span>
            </a>
        </li>
        
        
        <li >
            <a href='/blogs/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>Blogs</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>Search</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E5%8F%8B%E6%83%85%E9%93%BE%E6%8E%A5/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>友情链接</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>暗色模式</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">目录</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#简介">简介</a></li>
    <li><a href="#代码导读list_head-页表原理并不在此列自行了解">代码导读（list_head, 页表原理并不在此列，自行了解）</a></li>
    <li><a href="#练习题1">练习题1</a></li>
    <li><a href="#练习题2">练习题2</a></li>
    <li><a href="#练习题-3">练习题 3</a></li>
    <li><a href="#练习题4">练习题4</a></li>
    <li><a href="#挑战题7">挑战题7</a></li>
    <li><a href="#练习题-8-9-10">练习题 8, 9, 10</a></li>
    <li><a href="#挑战题-11">挑战题 11</a></li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/chcore/" style="background-color: #2a9d8f; color: #fff;">
                ChCore
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/blogs/chcore_lab2-%E5%81%9A%E9%A2%98%E7%AC%94%E8%AE%B0/">ChCore_lab2 做题笔记</a>
        </h2>
    
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Nov 24, 2024</time>
            </div>
        

        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <h2 id="简介">简介
</h2><p>文档链接：<a class="link" href="https://sjtu-ipads.github.io/OS-Course-Lab/Lab2.html"  target="_blank" rel="noopener"
    >Lab2: 内存管理 - IPADS OS Course Lab Manual</a></p>
<p>本实验主要目的在于让同学们熟悉内核启动过程中对内存的初始化和内核启动后对物理内存和页表的管理，包括三个部分。</p>
<ol>
<li><a class="link" href="https://sjtu-ipads.github.io/OS-Course-Lab/Lab2/physical.html"  target="_blank" rel="noopener"
    >物理内存管理</a>: 理解并完成伙伴系统以及SLAB系统</li>
<li><a class="link" href="https://sjtu-ipads.github.io/OS-Course-Lab/Lab2/pte.html"  target="_blank" rel="noopener"
    >虚拟页表管理</a>: 深入理解页表分配机制以及页表项权限机制，并完成页表分配函数。</li>
<li><a class="link" href="https://sjtu-ipads.github.io/OS-Course-Lab/Lab2/page_fault.html"  target="_blank" rel="noopener"
    >缺页异常处理</a>: 理解aarch64架构下的异常处理机制，并按照页表项的配置完成按需分配以及写时拷贝的缺页管理设置。</li>
</ol>
<blockquote>
<p><strong>！本次实验由于时间紧任务重，只完成代码部分</strong></p>
</blockquote>
<h2 id="代码导读list_head-页表原理并不在此列自行了解">代码导读（list_head, 页表原理并不在此列，自行了解）
</h2><p>从<code>main</code>函数讲起，在初始化完cpu信息之后，就开始初始化页表（<code>mm_init</code>）</p>
<img src="assets\image-20241117130710048-1732453364850-1.png" alt="image-20241117130710048" style="zoom:50%;" />
<ul>
<li><strong><code>mm_init</code> 函数</strong></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">mm_init</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">physmem_info</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">physmem_map_idx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* Step-1: 解析physmem_info以获取physmem的每个连续范围 */</span>
</span></span><span class="line"><span class="cl">        <span class="n">physmem_map_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">//表示总共有多少个内存池
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">parse_mem_map</span><span class="p">(</span><span class="n">physmem_info</span><span class="p">);</span> <span class="c1">// 解析完之后会修改上述的physmem_map_num值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* Step-2: init the buddy allocators for each continuous range of the
</span></span></span><span class="line"><span class="cl"><span class="cm">         * physmem. */</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="n">physmem_map_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">physmem_map_idx</span> <span class="o">&lt;</span> <span class="n">physmem_map_num</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">             <span class="o">++</span><span class="n">physmem_map_idx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="nf">init_buddy_for_one_physmem_map</span><span class="p">(</span><span class="n">physmem_map_idx</span><span class="p">);</span> <span class="c1">// 初始化内存池
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* Step-3: init the slab allocator. */</span>
</span></span><span class="line"><span class="cl">        <span class="nf">init_slab</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong><code>init_buddy_for_one_physmem_map</code>函数</strong></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">init_buddy_for_one_physmem_map</span><span class="p">(</span><span class="kt">int</span> <span class="n">physmem_map_idx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">paddr_t</span> <span class="n">free_mem_start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">       <span class="cm">/* ...省略变量初始化操作 */</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">        <span class="kt">paddr_t</span> <span class="n">free_page_start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">free_mem_start</span> <span class="o">=</span> <span class="n">physmem_map</span><span class="p">[</span><span class="n">physmem_map_idx</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span> <span class="c1">// 该内存池的起始地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">free_mem_end</span> <span class="o">=</span> <span class="n">physmem_map</span><span class="p">[</span><span class="n">physmem_map_idx</span><span class="p">][</span><span class="mi">1</span><span class="p">];</span> <span class="c1">// 该内存池的结束位置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    	<span class="c1">// 计算该内存池可以分配的页表数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">npages</span> <span class="o">=</span> <span class="p">(</span><span class="n">free_mem_end</span> <span class="o">-</span> <span class="n">free_mem_start</span><span class="p">)</span> <span class="c1">// 内存大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                 <span class="o">/</span> <span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">page</span><span class="p">));</span>  <span class="c1">// 要加上页表元数据的大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">free_page_start</span> <span class="o">=</span> <span class="nf">ROUND_UP</span><span class="p">(</span> <span class="c1">// 可分配的页表内存起始地址（ROUND_UP表示按页向上对齐）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">free_mem_start</span> <span class="o">+</span> <span class="n">npages</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">page</span><span class="p">),</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* 对齐后重新计算 npages。*/</span>
</span></span><span class="line"><span class="cl">        <span class="n">npages1</span> <span class="o">=</span> <span class="p">(</span><span class="n">free_mem_end</span> <span class="o">-</span> <span class="n">free_page_start</span><span class="p">)</span> <span class="o">/</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">npages</span> <span class="o">=</span> <span class="n">npages</span> <span class="o">&lt;</span> <span class="n">npages1</span> <span class="o">?</span> <span class="nl">npages</span> <span class="p">:</span> <span class="n">npages1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    	<span class="c1">// 将起始地址初始化为第一个页表元数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">page_meta_start</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="p">)</span><span class="nf">phys_to_virt</span><span class="p">(</span><span class="n">free_mem_start</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* 根据该空闲内存区域初始化伙伴分配器。 */</span>
</span></span><span class="line"><span class="cl">        <span class="nf">init_buddy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">global_mem</span><span class="p">[</span><span class="n">physmem_map_idx</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                   <span class="n">page_meta_start</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                   <span class="nf">phys_to_virt</span><span class="p">(</span><span class="n">free_page_start</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                   <span class="n">npages</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>页表相关结构体</strong></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">page</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="n">list_head</span> <span class="n">node</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">allocated</span><span class="p">;</span> <span class="c1">// 对应的物理页面现在是否空闲
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">int</span> <span class="n">order</span><span class="p">;</span> <span class="c1">// 该页面所属的内存块的阶数，判断内存页大小的唯一根据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">void</span> <span class="o">*</span><span class="n">slab</span><span class="p">;</span> <span class="c1">// 用于 ChCore slab 分配器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">struct</span> <span class="n">phys_mem_pool</span> <span class="o">*</span><span class="n">pool</span><span class="p">;</span> <span class="c1">// 所属的内存池
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">free_list</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="n">list_head</span> <span class="n">free_list</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nr_free</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">phys_mem_pool</span> <span class="p">{</span> <span class="c1">// 该结构体不归伙伴系统管辖
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">vaddr_t</span> <span class="n">pool_start_addr</span><span class="p">;</span> <span class="c1">// 该物理内存池的起始虚拟地址（供内核使用）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pool_mem_size</span><span class="p">;</span> <span class="c1">// 内存池管理的内存大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		
</span></span><span class="line"><span class="cl">    	<span class="c1">// 该池的元数据区域的起始虚拟地址（供内核使用）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page_metadata</span><span class="p">;</span>  <span class="c1">// 第一个页的地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">struct</span> <span class="n">lock</span> <span class="n">buddy_lock</span><span class="p">;</span> <span class="c1">// 内存池的锁
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="cm">/* 内存块的空闲列表，根据order存储 */</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="n">free_list</span> <span class="n">free_lists</span><span class="p">[</span><span class="n">BUDDY_MAX_ORDER</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">         * This field is only used in ChCore unit test.
</span></span></span><span class="line"><span class="cl"><span class="cm">         * The number of (4k) physical pages in this physical memory pool.
</span></span></span><span class="line"><span class="cl"><span class="cm">         * 不重要
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span>
</span></span><span class="line"><span class="cl">        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pool_phys_page_num</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>初始化伙伴系统</strong></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">init_buddy</span><span class="p">(</span><span class="k">struct</span> <span class="n">phys_mem_pool</span> <span class="o">*</span><span class="n">pool</span><span class="p">,</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">start_page</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="kt">vaddr_t</span> <span class="n">start_addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">page_num</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">order</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">page_idx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">BUG_ON</span><span class="p">(</span><span class="nf">lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">buddy_lock</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* 初始化物理内存池的元数据 */</span>
</span></span><span class="line"><span class="cl">        <span class="n">pool</span><span class="o">-&gt;</span><span class="n">pool_start_addr</span> <span class="o">=</span> <span class="n">start_addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">pool</span><span class="o">-&gt;</span><span class="n">page_metadata</span> <span class="o">=</span> <span class="n">start_page</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">pool</span><span class="o">-&gt;</span><span class="n">pool_mem_size</span> <span class="o">=</span> <span class="n">page_num</span> <span class="o">*</span> <span class="n">BUDDY_PAGE_SIZE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* This field is for unit test only. （不重要）*/</span>
</span></span><span class="line"><span class="cl">        <span class="n">pool</span><span class="o">-&gt;</span><span class="n">pool_phys_page_num</span> <span class="o">=</span> <span class="n">page_num</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* 初始化内存池中的链表 */</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="n">order</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">order</span> <span class="o">&lt;</span> <span class="n">BUDDY_MAX_ORDER</span><span class="p">;</span> <span class="o">++</span><span class="n">order</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">pool</span><span class="o">-&gt;</span><span class="n">free_lists</span><span class="p">[</span><span class="n">order</span><span class="p">].</span><span class="n">nr_free</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="nf">init_list_head</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">free_lists</span><span class="p">[</span><span class="n">order</span><span class="p">].</span><span class="n">free_list</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* 初始化所有的页表元数据为 0 */</span>
</span></span><span class="line"><span class="cl">        <span class="nf">memset</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">start_page</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">page_num</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">page</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* 初始化所有的页表元数据为 已分配. */</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="n">page_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">page_idx</span> <span class="o">&lt;</span> <span class="n">page_num</span><span class="p">;</span> <span class="o">++</span><span class="n">page_idx</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">page</span> <span class="o">=</span> <span class="n">start_page</span> <span class="o">+</span> <span class="n">page_idx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">page</span><span class="o">-&gt;</span><span class="n">allocated</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">page</span><span class="o">-&gt;</span><span class="n">order</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">page</span><span class="o">-&gt;</span><span class="n">pool</span> <span class="o">=</span> <span class="n">pool</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* 通过buddy_free_pages函数来将页表放入内存池的链表内 */</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="n">page_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">page_idx</span> <span class="o">&lt;</span> <span class="n">page_num</span><span class="p">;</span> <span class="o">++</span><span class="n">page_idx</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">page</span> <span class="o">=</span> <span class="n">start_page</span> <span class="o">+</span> <span class="n">page_idx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="nf">buddy_free_pages</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>获取伙伴块以及地址转换函数</strong></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">__maybe_unused</span> <span class="k">static</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="nf">get_buddy_chunk</span><span class="p">(</span><span class="k">struct</span> <span class="n">phys_mem_pool</span> <span class="o">*</span><span class="n">pool</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                   <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">chunk</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">vaddr_t</span> <span class="n">chunk_addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">vaddr_t</span> <span class="n">buddy_chunk_addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">order</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* Get the address of the chunk. */</span>
</span></span><span class="line"><span class="cl">        <span class="n">chunk_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">vaddr_t</span><span class="p">)</span><span class="nf">page_to_virt</span><span class="p">(</span><span class="n">chunk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">order</span> <span class="o">=</span> <span class="n">chunk</span><span class="o">-&gt;</span><span class="n">order</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">        <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">         * Calculate the address of the buddy chunk according to the address
</span></span></span><span class="line"><span class="cl"><span class="cm">         * relationship between buddies.
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span> 
</span></span><span class="line"><span class="cl">    	<span class="c1">// 根据order和chunk在特定位取反来获取伙伴块地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">buddy_chunk_addr</span> <span class="o">=</span> <span class="n">chunk_addr</span>
</span></span><span class="line"><span class="cl">                           <span class="o">^</span> <span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">order</span> <span class="o">+</span> <span class="n">BUDDY_PAGE_SIZE_ORDER</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* Check whether the buddy_chunk_addr belongs to pool. */</span>
</span></span><span class="line"><span class="cl">    	<span class="c1">// 判断该伙伴块是否在这个内存池的管辖范围
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">((</span><span class="n">buddy_chunk_addr</span> <span class="o">&lt;</span> <span class="n">pool</span><span class="o">-&gt;</span><span class="n">pool_start_addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">||</span> <span class="p">((</span><span class="n">buddy_chunk_addr</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">order</span><span class="p">)</span> <span class="o">*</span> <span class="n">BUDDY_PAGE_SIZE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">&gt;</span> <span class="p">(</span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">pool_start_addr</span> <span class="o">+</span> <span class="n">pool</span><span class="o">-&gt;</span><span class="n">pool_mem_size</span><span class="p">)))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nf">virt_to_page</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">buddy_chunk_addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="o">*</span><span class="nf">page_to_virt</span><span class="p">(</span><span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">vaddr_t</span> <span class="n">addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="n">phys_mem_pool</span> <span class="o">*</span><span class="n">pool</span> <span class="o">=</span> <span class="n">page</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">BUG_ON</span><span class="p">(</span><span class="n">pool</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* page_idx * BUDDY_PAGE_SIZE + start_addr */</span>
</span></span><span class="line"><span class="cl">        <span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">page</span> <span class="o">-</span> <span class="n">pool</span><span class="o">-&gt;</span><span class="n">page_metadata</span><span class="p">)</span> <span class="o">*</span> <span class="n">BUDDY_PAGE_SIZE</span>
</span></span><span class="line"><span class="cl">               <span class="o">+</span> <span class="n">pool</span><span class="o">-&gt;</span><span class="n">pool_start_addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="nf">virt_to_page</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="n">phys_mem_pool</span> <span class="o">*</span><span class="n">pool</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">vaddr_t</span> <span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">vaddr_t</span><span class="p">)</span><span class="n">ptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* 找到对应的物理内存池 */</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">physmem_map_num</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&gt;=</span> <span class="n">global_mem</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pool_start_addr</span>
</span></span><span class="line"><span class="cl">                    <span class="o">&amp;&amp;</span> <span class="n">addr</span> <span class="o">&lt;</span> <span class="n">global_mem</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pool_start_addr</span>
</span></span><span class="line"><span class="cl">                                       <span class="o">+</span> <span class="n">global_mem</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pool_mem_size</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="n">pool</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">global_mem</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">                        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">pool</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nf">kdebug</span><span class="p">(</span><span class="s">&#34;invalid pool in %s&#34;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// 根据输入虚拟的地址计算出对应的页表地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">page</span> <span class="o">=</span> <span class="n">pool</span><span class="o">-&gt;</span><span class="n">page_metadata</span>
</span></span><span class="line"><span class="cl">               <span class="o">+</span> <span class="p">(((</span><span class="kt">vaddr_t</span><span class="p">)</span><span class="n">addr</span> <span class="o">-</span> <span class="n">pool</span><span class="o">-&gt;</span><span class="n">pool_start_addr</span><span class="p">)</span> <span class="o">/</span> <span class="n">BUDDY_PAGE_SIZE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">page</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="练习题1">练习题1
</h2><p>完成 <code>kernel/mm/buddy.c</code> 中的 <code>split_chunk</code>、<code>merge_chunk</code>、<code>buddy_get_pages</code>、 和 <code>buddy_free_pages</code> 函数中的 <code>LAB 2 TODO 1</code> 部分，其中 <code>buddy_get_pages</code> 用于分配指定阶大小的连续物理页，<code>buddy_free_pages</code> 用于释放已分配的连续物理页。</p>
<blockquote>
<p>根据<code>init_buddy</code>中对<code>buddy_free_pages</code>的使用，我们知道这个函数主要是将<code>page-&gt;allocated</code>设置回0，再结合伙伴系统的知识，我们知道在释放完内存之后还要尽可能地合并伙伴，即调用<code>merge_chunk</code>函数</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">buddy_free_pages</span><span class="p">(</span><span class="k">struct</span> <span class="n">phys_mem_pool</span> <span class="o">*</span><span class="n">pool</span><span class="p">,</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">order</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">free_list</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nf">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">buddy_lock</span><span class="p">);</span> <span class="c1">// 为了保证多线程数据安全，操作内存池时要获取锁
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* LAB 2 TODO 1 BEGIN */</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">         * Hint: Merge the chunk with its buddy and put it into
</span></span></span><span class="line"><span class="cl"><span class="cm">         * a suitable free list.
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* BLANK BEGIN */</span>
</span></span><span class="line"><span class="cl">        <span class="n">page</span><span class="o">-&gt;</span><span class="n">allocated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// 先设置为未分配
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">page</span> <span class="o">=</span> <span class="nf">merge_chunk</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span> <span class="c1">// 合并伙伴块
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">order</span> <span class="o">=</span> <span class="n">page</span><span class="o">-&gt;</span><span class="n">order</span><span class="p">;</span>  <span class="c1">// 获取合并之后的伙伴 order 值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    	<span class="c1">// 由于merge之后page所指向不一定是原来的page，为了保险，再次设置为未分配
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    	<span class="n">page</span><span class="o">-&gt;</span><span class="n">allocated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    	<span class="c1">// 将页表放入内存池中进行管理
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">free_list</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">free_lists</span><span class="p">[</span><span class="n">order</span><span class="p">].</span><span class="n">free_list</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">page</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">),</span> <span class="n">free_list</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">pool</span><span class="o">-&gt;</span><span class="n">free_lists</span><span class="p">[</span><span class="n">order</span><span class="p">].</span><span class="n">nr_free</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* BLANK END */</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* LAB 2 TODO 1 END */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">buddy_lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">__maybe_unused</span> <span class="k">static</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="nf">merge_chunk</span><span class="p">(</span><span class="k">struct</span> <span class="n">phys_mem_pool</span> <span class="o">*</span><span class="n">__maybe_unused</span> <span class="n">pool</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">__maybe_unused</span> <span class="n">chunk</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* LAB 2 TODO 1 BEGIN */</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">         * Hint: Recursively merge current chunk with its buddy
</span></span></span><span class="line"><span class="cl"><span class="cm">         * if possible. 递归合并至不能合并
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* BLANK BEGIN */</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">chunk</span><span class="o">-&gt;</span><span class="n">order</span> <span class="o">==</span> <span class="n">BUDDY_MAX_ORDER</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="c1">// 如果当前块已经是最大块，直接返回本身
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">return</span> <span class="n">chunk</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">buddy_chunk</span> <span class="o">=</span> <span class="nf">get_buddy_chunk</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">chunk</span><span class="p">);</span> <span class="c1">// 获取伙伴块
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    	<span class="c1">// 如果找不到伙伴、伙伴被分配、伙伴的阶数与自己不等（该页不完整）就停止合并
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">buddy_chunk</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">chunk</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">buddy_chunk</span><span class="o">-&gt;</span><span class="n">allocated</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">chunk</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">buddy_chunk</span><span class="o">-&gt;</span><span class="n">order</span> <span class="o">!=</span> <span class="n">chunk</span><span class="o">-&gt;</span><span class="n">order</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">chunk</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// 如果能够合并，就将伙伴从内存池中取出
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">buddy_chunk</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">pool</span><span class="o">-&gt;</span><span class="n">free_lists</span><span class="p">[</span><span class="n">buddy_chunk</span><span class="o">-&gt;</span><span class="n">order</span><span class="p">].</span><span class="n">nr_free</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">    	<span class="c1">// 将两个伙伴合并
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">buddy_chunk</span><span class="o">-&gt;</span><span class="n">order</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">chunk</span><span class="o">-&gt;</span><span class="n">order</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">buddy_chunk</span> <span class="o">&lt;</span> <span class="n">chunk</span><span class="p">)</span> <span class="c1">// 确保低地址在前
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">chunk</span> <span class="o">=</span> <span class="n">buddy_chunk</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nf">merge_chunk</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">chunk</span><span class="p">);</span> <span class="c1">// 递归合并并返回合并后的块
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="cm">/* BLANK END */</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* LAB 2 TODO 1 END */</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>参照<code>merge_chunk</code>和<code>buddy_free_pages</code>，实现<code>split_chunk</code>和<code>buddy_get_pages</code></p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="nf">buddy_get_pages</span><span class="p">(</span><span class="k">struct</span> <span class="n">phys_mem_pool</span> <span class="o">*</span><span class="n">pool</span><span class="p">,</span> <span class="kt">int</span> <span class="n">order</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">cur_order</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">free_list</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nf">unlikely</span><span class="p">(</span><span class="n">order</span> <span class="o">&gt;=</span> <span class="n">BUDDY_MAX_ORDER</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nf">kwarn</span><span class="p">(</span><span class="s">&#34;ChCore does not support allocating such too large &#34;</span>
</span></span><span class="line"><span class="cl">                      <span class="s">&#34;contious physical memory</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">buddy_lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* LAB 2 TODO 1 BEGIN */</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">         * Hint: Find a chunk that satisfies the order requirement
</span></span></span><span class="line"><span class="cl"><span class="cm">         * in the free lists, then split it if necessary.
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* BLANK BEGIN */</span>
</span></span><span class="line"><span class="cl">        <span class="n">cur_order</span> <span class="o">=</span> <span class="n">order</span><span class="p">;</span> <span class="c1">// 找到符合条件的空闲块
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">while</span> <span class="p">(</span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">free_lists</span><span class="p">[</span><span class="n">cur_order</span><span class="p">].</span><span class="n">nr_free</span> <span class="o">&lt;=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">               <span class="o">&amp;&amp;</span> <span class="n">cur_order</span> <span class="o">&lt;</span> <span class="n">BUDDY_MAX_ORDER</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">cur_order</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">cur_order</span> <span class="o">&gt;=</span> <span class="n">BUDDY_MAX_ORDER</span><span class="p">)</span> <span class="c1">// 如果没找到则返回
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// 取出一个空闲块
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">free_list</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">free_lists</span><span class="p">[</span><span class="n">cur_order</span><span class="p">].</span><span class="n">free_list</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    	<span class="c1">// 这里的链表头是一个不存东西的
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">page</span> <span class="o">=</span> <span class="nf">list_entry</span><span class="p">(</span><span class="n">free_list</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">page</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    	<span class="n">pool</span><span class="o">-&gt;</span><span class="n">free_lists</span><span class="p">[</span><span class="n">page</span><span class="o">-&gt;</span><span class="n">order</span><span class="p">].</span><span class="n">nr_free</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nf">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">page</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// 将空闲块分割为想要的块
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">page</span> <span class="o">=</span> <span class="nf">split_chunk</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">page</span><span class="o">-&gt;</span><span class="n">allocated</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* BLANK END */</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* LAB 2 TODO 1 END */</span>
</span></span><span class="line"><span class="cl"><span class="nl">out</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">__maybe_unused</span> <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">buddy_lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">page</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">__maybe_unused</span> <span class="k">static</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="nf">split_chunk</span><span class="p">(</span><span class="k">struct</span> <span class="n">phys_mem_pool</span> <span class="o">*</span><span class="n">__maybe_unused</span> <span class="n">pool</span><span class="p">,</span> <span class="kt">int</span> <span class="n">__maybe_unused</span> <span class="n">order</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">__maybe_unused</span> <span class="n">chunk</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* LAB 2 TODO 1 BEGIN */</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">         * Hint: Recursively put the buddy of current chunk into
</span></span></span><span class="line"><span class="cl"><span class="cm">         * a suitable free list.
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* BLANK BEGIN */</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">chunk</span><span class="o">-&gt;</span><span class="n">order</span> <span class="o">==</span> <span class="n">order</span><span class="p">)</span> <span class="c1">// 如果当前块阶数等于想要的阶数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">return</span> <span class="n">chunk</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">        <span class="n">chunk</span><span class="o">-&gt;</span><span class="n">order</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// 缩小当前快为原来一半
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">buddy</span> <span class="o">=</span> <span class="nf">get_buddy_chunk</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">chunk</span><span class="p">);</span> <span class="c1">// 获取伙伴块
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    	<span class="c1">// 将伙伴块设置为未分配，并且将伙伴块放入内存池中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">buddy</span><span class="o">-&gt;</span><span class="n">allocated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">buddy</span><span class="o">-&gt;</span><span class="n">order</span> <span class="o">=</span> <span class="n">chunk</span><span class="o">-&gt;</span><span class="n">order</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">pool</span><span class="o">-&gt;</span><span class="n">free_lists</span><span class="p">[</span><span class="n">buddy</span><span class="o">-&gt;</span><span class="n">order</span><span class="p">].</span><span class="n">nr_free</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nf">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">buddy</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">),</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">free_lists</span><span class="p">[</span><span class="n">buddy</span><span class="o">-&gt;</span><span class="n">order</span><span class="p">].</span><span class="n">free_list</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nf">split_chunk</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">chunk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* BLANK END */</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* LAB 2 TODO 1 END */</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="练习题2">练习题2
</h2><p>完成 <code>kernel/mm/slab.c</code> 中的 <code>choose_new_current_slab</code>、<code>alloc_in_slab_impl</code> 和 <code>free_in_slab</code> 函数中的 <code>LAB 2 TODO 2</code> 部分，其中 <code>alloc_in_slab_impl</code> 用于在 slab 分配器中分配指定阶大小的内存，而 <code>free_in_slab</code> 则用于释放上述已分配的内存。</p>
<p><strong>前置代码：</strong></p>
<p>在初始化完伙伴分配器之后，开始初始化slab分配器</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">init_slab</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">order</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* slab obj size: 32, 64, 128, 256, 512, 1024, 2048 （单位：B）*/</span>
</span></span><span class="line"><span class="cl">    	<span class="c1">// 根据上述单位大小，我们可以知道slab的阶数为 5 到 11 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">for</span> <span class="p">(</span><span class="n">order</span> <span class="o">=</span> <span class="n">SLAB_MIN_ORDER</span><span class="p">;</span> <span class="n">order</span> <span class="o">&lt;=</span> <span class="n">SLAB_MAX_ORDER</span><span class="p">;</span> <span class="n">order</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nf">lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slabs_locks</span><span class="p">[</span><span class="n">order</span><span class="p">]);</span> <span class="c1">// 初始化锁
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">slab_pool</span><span class="p">[</span><span class="n">order</span><span class="p">].</span><span class="n">current_slab</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="c1">// 初始化池
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nf">init_list_head</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">slab_pool</span><span class="p">[</span><span class="n">order</span><span class="p">].</span><span class="n">partial_slab_list</span><span class="p">));</span> <span class="c1">// 初始化链表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nf">kdebug</span><span class="p">(</span><span class="s">&#34;mm: finish initing slab allocators</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>slab_pool</code>的定义</p>
<img src="D:\desktop\Git\blogs\content\post\chcore_lab2\assets\image-20241117150803653-1732453364850-2.png" alt="image-20241117150803653" style="zoom:50%;" />
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">slab_pointer</span> <span class="n">slab_pool</span><span class="p">[</span><span class="n">SLAB_MAX_ORDER</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">slab_pointer</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="n">slab_header</span> <span class="o">*</span><span class="n">current_slab</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="n">list_head</span> <span class="n">partial_slab_list</span><span class="p">;</span> <span class="c1">// 串slab_header的链表头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* slab_header 位于每个 slab 的开头 (内容存储在第一个 slot). */</span>
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">slab_header</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* 空闲slot列表，可以转换为struct slab_slot_list. */</span>
</span></span><span class="line"><span class="cl">        <span class="kt">void</span> <span class="o">*</span><span class="n">free_list_head</span><span class="p">;</span> <span class="c1">// 用来将空闲位置串起来
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="cm">/* Partial slab list. */</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="n">list_head</span> <span class="n">node</span><span class="p">;</span> <span class="c1">// 每个slab都要和其它slab串起来
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">order</span><span class="p">;</span> <span class="c1">// 阶数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">total_free_cnt</span><span class="p">;</span> <span class="cm">/* MAX: 65536 */</span>
</span></span><span class="line"><span class="cl">        <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">current_free_cnt</span><span class="p">;</span> <span class="c1">// 当前空闲数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 一个slab中的每个空闲slot都被视为slab_slot_list。. */</span>
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">slab_slot_list</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">void</span> <span class="o">*</span><span class="n">next_free</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="k">struct</span> <span class="n">slab_header</span> <span class="o">*</span><span class="nf">init_slab_cache</span><span class="p">(</span><span class="kt">int</span> <span class="n">order</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">void</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="n">slab_slot_list</span> <span class="o">*</span><span class="n">slot</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="n">slab_header</span> <span class="o">*</span><span class="n">slab</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">obj_size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">addr</span> <span class="o">=</span> <span class="nf">alloc_slab_memory</span><span class="p">(</span><span class="n">size</span><span class="p">);</span> <span class="c1">// 分配一个内存来当作slab
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="nf">unlikely</span><span class="p">(</span><span class="n">addr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="cm">/* Fail: no available memory. */</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">slab</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">slab_header</span> <span class="o">*</span><span class="p">)</span><span class="n">addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">obj_size</span> <span class="o">=</span> <span class="nf">order_to_size</span><span class="p">(</span><span class="n">order</span><span class="p">);</span>  <span class="c1">// 每个槽的大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="cm">/* The first slot is used as metadata (struct slab_header). */</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BUG_ON</span><span class="p">(</span><span class="n">obj_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">cnt</span> <span class="o">=</span> <span class="n">size</span> <span class="o">/</span> <span class="n">obj_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// 总共可用的槽数量（第一个槽存元数据）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  		<span class="c1">// 第二个槽的地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">slot</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">slab_slot_list</span> <span class="o">*</span><span class="p">)((</span><span class="kt">vaddr_t</span><span class="p">)</span><span class="n">addr</span> <span class="o">+</span> <span class="n">obj_size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    	<span class="c1">// 将第二个槽放入链表头，根据上下文，可以知道这个链表头是可用的，而不像伙伴系统的链表头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">slab</span><span class="o">-&gt;</span><span class="n">free_list_head</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">slot</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">slab</span><span class="o">-&gt;</span><span class="n">order</span> <span class="o">=</span> <span class="n">order</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">slab</span><span class="o">-&gt;</span><span class="n">total_free_cnt</span> <span class="o">=</span> <span class="n">cnt</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">slab</span><span class="o">-&gt;</span><span class="n">current_free_cnt</span> <span class="o">=</span> <span class="n">cnt</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* 循环将所有的空闲槽串起来 &amp; The last slot has no next one. */</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cnt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">slot</span><span class="o">-&gt;</span><span class="n">next_free</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">slot</span> <span class="o">+</span> <span class="n">obj_size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">slot</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">slab_slot_list</span> <span class="o">*</span><span class="p">)((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">slot</span>
</span></span><span class="line"><span class="cl">                                                 <span class="o">+</span> <span class="n">obj_size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">slot</span><span class="o">-&gt;</span><span class="n">next_free</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">slab</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>题解：</strong></p>
<blockquote>
<p><code>choose_new_current_slab</code>函数，从<code>slab_list</code>中将下一个<code>slab</code>放到<code>current_slab</code>上</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">choose_new_current_slab</span><span class="p">(</span><span class="k">struct</span> <span class="n">slab_pointer</span> <span class="o">*</span><span class="n">__maybe_unused</span> <span class="n">pool</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* LAB 2 TODO 2 BEGIN */</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* Hint: Choose a partial slab to be a new current slab. */</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* BLANK BEGIN */</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">slab_list</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">slab_list</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">partial_slab_list</span><span class="p">);</span> <span class="c1">// 获取slab list链表头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="nf">list_empty</span><span class="p">(</span><span class="n">slab_list</span><span class="p">))</span> <span class="p">{</span> <span class="c1">// 如果为空则将current_slab设置为空
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">pool</span><span class="o">-&gt;</span><span class="n">current_slab</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span><span class="c1">// 获取下一个slab，并将current_slab设置为它，然后从链表中删除
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">struct</span> <span class="n">slab_header</span> <span class="o">*</span><span class="n">slab</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">slab</span> <span class="o">=</span> <span class="nf">list_entry</span><span class="p">(</span><span class="n">slab_list</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">slab_header</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">pool</span><span class="o">-&gt;</span><span class="n">current_slab</span> <span class="o">=</span> <span class="n">slab</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="nf">list_del</span><span class="p">(</span><span class="n">slab_list</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* BLANK END */</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* LAB 2 TODO 2 END */</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p><code>alloc_in_slab_impl</code>函数，在slab中获取一个空闲空间</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">alloc_in_slab_impl</span><span class="p">(</span><span class="kt">int</span> <span class="n">order</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="n">slab_header</span> <span class="o">*</span><span class="n">current_slab</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="n">slab_slot_list</span> <span class="o">*</span><span class="n">free_list</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">void</span> <span class="o">*</span><span class="n">next_slot</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nf">UNUSED</span><span class="p">(</span><span class="n">next_slot</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slabs_locks</span><span class="p">[</span><span class="n">order</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">current_slab</span> <span class="o">=</span> <span class="n">slab_pool</span><span class="p">[</span><span class="n">order</span><span class="p">].</span><span class="n">current_slab</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">        <span class="cm">/* When serving the first allocation request. */</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nf">unlikely</span><span class="p">(</span><span class="n">current_slab</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span> <span class="c1">// 当这个slab没有被初始化时，先初始化
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">current_slab</span> <span class="o">=</span> <span class="nf">init_slab_cache</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">SIZE_OF_ONE_SLAB</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">current_slab</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// 初始化失败返回空
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slabs_locks</span><span class="p">[</span><span class="n">order</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">                        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="n">slab_pool</span><span class="p">[</span><span class="n">order</span><span class="p">].</span><span class="n">current_slab</span> <span class="o">=</span> <span class="n">current_slab</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* LAB 2 TODO 2 BEGIN */</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">         * Hint: Find a free slot from the free list of current slab.
</span></span></span><span class="line"><span class="cl"><span class="cm">         * If current slab is full, choose a new slab as the current one.
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* BLANK BEGIN */</span>
</span></span><span class="line"><span class="cl">        <span class="n">free_list</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">slab_slot_list</span> <span class="o">*</span><span class="p">)(</span><span class="n">current_slab</span><span class="o">-&gt;</span><span class="n">free_list_head</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BUG_ON</span><span class="p">(</span><span class="n">free_list</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">        <span class="n">next_slot</span> <span class="o">=</span> <span class="n">free_list</span><span class="o">-&gt;</span><span class="n">next_free</span><span class="p">;</span> <span class="c1">// 获得下一个空闲slot
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">current_slab</span><span class="o">-&gt;</span><span class="n">free_list_head</span> <span class="o">=</span> <span class="n">next_slot</span><span class="p">;</span> <span class="c1">// 将head设置为next
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">current_slab</span><span class="o">-&gt;</span><span class="n">current_free_cnt</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// 空闲减一
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    	<span class="c1">// 如果分配完这次之后没有可分配的空间了，就将下一个slab的换上来
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="nf">unlikely</span><span class="p">(</span><span class="n">current_slab</span><span class="o">-&gt;</span><span class="n">current_free_cnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> 
</span></span><span class="line"><span class="cl">                <span class="nf">choose_new_current_slab</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">slab_pool</span><span class="p">[</span><span class="n">order</span><span class="p">]));</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* BLANK END */</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* LAB 2 TODO 2 END */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slabs_locks</span><span class="p">[</span><span class="n">order</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">free_list</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 这里形成闭环，当所有的slab分配完之后，我们调用choose_new_current_slab就会将current_slab设置为NULL，再次调用这个函数时就又会从伙伴系统中分配一个slab
</span></span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p><code>free_in_slab</code>函数，释放已分配的<code>slot</code></p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">free_in_slab</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="n">slab_header</span> <span class="o">*</span><span class="n">slab</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="n">slab_slot_list</span> <span class="o">*</span><span class="n">slot</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">order</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">slot</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">slab_slot_list</span> <span class="o">*</span><span class="p">)</span><span class="n">addr</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">        <span class="n">page</span> <span class="o">=</span> <span class="nf">virt_to_page</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">page</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nf">kdebug</span><span class="p">(</span><span class="s">&#34;invalid page in %s&#34;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">slab</span> <span class="o">=</span> <span class="n">page</span><span class="o">-&gt;</span><span class="n">slab</span><span class="p">;</span> <span class="c1">// 获取对应的slab
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">order</span> <span class="o">=</span> <span class="n">slab</span><span class="o">-&gt;</span><span class="n">order</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">        <span class="nf">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slabs_locks</span><span class="p">[</span><span class="n">order</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">try_insert_full_slab_to_partial</span><span class="p">(</span><span class="n">slab</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#if ENABLE_DETECTING_DOUBLE_FREE_IN_SLAB == ON
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>        <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">         * SLAB double free detection: check whether the slot to free is
</span></span></span><span class="line"><span class="cl"><span class="cm">         * already in the free list.
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nf">check_slot_is_free</span><span class="p">(</span><span class="n">slab</span><span class="p">,</span> <span class="n">slot</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nf">kinfo</span><span class="p">(</span><span class="s">&#34;SLAB: double free detected. Address is %p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                      <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">slot</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="nf">BUG_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* LAB 2 TODO 2 BEGIN */</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">         * Hint: Free an allocated slot and put it back to the free list.
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* BLANK BEGIN */</span>
</span></span><span class="line"><span class="cl">    	<span class="c1">// 类似于链栈操作
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">slot</span><span class="o">-&gt;</span><span class="n">next_free</span> <span class="o">=</span> <span class="n">slab</span><span class="o">-&gt;</span><span class="n">free_list_head</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">slab</span><span class="o">-&gt;</span><span class="n">free_list_head</span> <span class="o">=</span> <span class="n">slot</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">slab</span><span class="o">-&gt;</span><span class="n">current_free_cnt</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* BLANK END */</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* LAB 2 TODO 2 END */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">try_return_slab_to_buddy</span><span class="p">(</span><span class="n">slab</span><span class="p">,</span> <span class="n">order</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slabs_locks</span><span class="p">[</span><span class="n">order</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="练习题-3">练习题 3
</h2><blockquote>
<p>完成 <code>kernel/mm/kmalloc.c</code> 中的 <code>_kmalloc</code> 函数中的 <code>LAB 2 TODO 3</code> 部分，在适当位置调用对应的函数，实现 <code>kmalloc</code> 功能</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="o">*</span><span class="nf">_kmalloc</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">is_record</span><span class="p">,</span> <span class="kt">size_t</span> <span class="o">*</span><span class="n">real_size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">void</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">order</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nf">unlikely</span><span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">ZERO_SIZE_PTR</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;=</span> <span class="n">SLAB_MAX_SIZE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="cm">/* LAB 2 TODO 3 BEGIN */</span>
</span></span><span class="line"><span class="cl">                <span class="cm">/* Step 1: Allocate in slab for small requests. */</span>
</span></span><span class="line"><span class="cl">                <span class="cm">/* BLANK BEGIN */</span>
</span></span><span class="line"><span class="cl">            	<span class="c1">// 通过查看alloc_in_slab函数，发现只需要将参数传进去
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">addr</span> <span class="o">=</span> <span class="nf">alloc_in_slab</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">real_size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="cm">/* BLANK END */</span>
</span></span><span class="line"><span class="cl"><span class="cp">#if ENABLE_MEMORY_USAGE_COLLECTING == ON
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>                <span class="k">if</span> <span class="p">(</span><span class="n">is_record</span> <span class="o">&amp;&amp;</span> <span class="n">collecting_switch</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="nf">record_mem_usage</span><span class="p">(</span><span class="o">*</span><span class="n">real_size</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="cm">/* Step 2: Allocate in buddy for large requests. */</span>
</span></span><span class="line"><span class="cl">                <span class="cm">/* BLANK BEGIN */</span>
</span></span><span class="line"><span class="cl">            	<span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            	<span class="c1">// 我们可以手搓获取order，但参考alloc_in_slab
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            	<span class="c1">// 我们发现已经有一个size_to_page_order的方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">order</span> <span class="o">=</span> <span class="nf">size_to_page_order</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">addr</span> <span class="o">=</span> <span class="nf">get_pages</span><span class="p">(</span><span class="n">order</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="cm">/* BLANK END */</span>
</span></span><span class="line"><span class="cl">                <span class="cm">/* LAB 2 TODO 3 END */</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="练习题4">练习题4
</h2><p>完成 <code>kernel/arch/aarch64/mm/page_table.c</code> 中的 <code>query_in_pgtbl</code>、<code>map_range_in_pgtbl_common</code>、<code>unmap_range_in_pgtbl</code> 和 <code>mprotect_in_pgtbl</code> 函数中的 <code>LAB 2 TODO 4</code> 部分，分别实现页表查询、映射、取消映射和修改页表权限的操作，以 4KB 页为粒度。</p>
<p><strong>前置代码：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">union</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">u64</span> <span class="nl">is_valid</span>        <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nl">is_table</span>        <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nl">ignored1</span>        <span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nl">next_table_addr</span> <span class="p">:</span> <span class="mi">36</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nl">reserved</span>        <span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nl">ignored2</span>        <span class="p">:</span> <span class="mi">7</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nl">PXNTable</span>        <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>   <span class="c1">// Privileged Execute-never for next level
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="nl">XNTable</span>         <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>   <span class="c1">// Execute-never for next level
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="nl">APTable</span>         <span class="p">:</span> <span class="mi">2</span><span class="p">,</span>   <span class="c1">// Access permissions for next level
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="nl">NSTable</span>         <span class="p">:</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="n">table</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">u64</span> <span class="nl">is_valid</span>        <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nl">is_table</span>        <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nl">attr_index</span>      <span class="p">:</span> <span class="mi">3</span><span class="p">,</span>   <span class="c1">// Memory attributes index
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="nl">NS</span>              <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>   <span class="c1">// Non-secure
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="nl">AP</span>              <span class="p">:</span> <span class="mi">2</span><span class="p">,</span>   <span class="c1">// Data access permissions
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="nl">SH</span>              <span class="p">:</span> <span class="mi">2</span><span class="p">,</span>   <span class="c1">// Shareability
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="nl">AF</span>              <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>   <span class="c1">// Accesss flag
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="nl">nG</span>              <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>   <span class="c1">// Not global bit
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="nl">reserved1</span>       <span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nl">nT</span>              <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nl">reserved2</span>       <span class="p">:</span> <span class="mi">13</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nl">pfn</span>             <span class="p">:</span> <span class="mi">18</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nl">reserved3</span>       <span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nl">GP</span>              <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nl">reserved4</span>       <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nl">DBM</span>             <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>   <span class="c1">// Dirty bit modifier
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="nl">Contiguous</span>      <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nl">PXN</span>             <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>   <span class="c1">// Privileged execute-never
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="nl">UXN</span>             <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>   <span class="c1">// Execute never
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="nl">soft_reserved</span>   <span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nl">PBHA</span>            <span class="p">:</span> <span class="mi">4</span><span class="p">;</span>   <span class="c1">// Page based hardware attributes
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span> <span class="n">l1_block</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">u64</span> <span class="nl">is_valid</span>        <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nl">is_table</span>        <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nl">attr_index</span>      <span class="p">:</span> <span class="mi">3</span><span class="p">,</span>   <span class="c1">// Memory attributes index
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="nl">NS</span>              <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>   <span class="c1">// Non-secure
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="nl">AP</span>              <span class="p">:</span> <span class="mi">2</span><span class="p">,</span>   <span class="c1">// Data access permissions
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="nl">SH</span>              <span class="p">:</span> <span class="mi">2</span><span class="p">,</span>   <span class="c1">// Shareability
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="nl">AF</span>              <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>   <span class="c1">// Accesss flag
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="nl">nG</span>              <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>   <span class="c1">// Not global bit
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="nl">reserved1</span>       <span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nl">nT</span>              <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nl">reserved2</span>       <span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nl">pfn</span>             <span class="p">:</span> <span class="mi">27</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nl">reserved3</span>       <span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nl">GP</span>              <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nl">reserved4</span>       <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nl">DBM</span>             <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>   <span class="c1">// Dirty bit modifier
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="nl">Contiguous</span>      <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nl">PXN</span>             <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>   <span class="c1">// Privileged execute-never
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="nl">UXN</span>             <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>   <span class="c1">// Execute never
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="nl">soft_reserved</span>   <span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nl">PBHA</span>            <span class="p">:</span> <span class="mi">4</span><span class="p">;</span>   <span class="c1">// Page based hardware attributes
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span> <span class="n">l2_block</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">u64</span> <span class="nl">is_valid</span>        <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nl">is_page</span>         <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nl">attr_index</span>      <span class="p">:</span> <span class="mi">3</span><span class="p">,</span>   <span class="c1">// Memory attributes index
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="nl">NS</span>              <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>   <span class="c1">// Non-secure
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="nl">AP</span>              <span class="p">:</span> <span class="mi">2</span><span class="p">,</span>   <span class="c1">// Data access permissions
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="nl">SH</span>              <span class="p">:</span> <span class="mi">2</span><span class="p">,</span>   <span class="c1">// Shareability
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="nl">AF</span>              <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>   <span class="c1">// Accesss flag
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="nl">nG</span>              <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>   <span class="c1">// Not global bit
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="nl">pfn</span>             <span class="p">:</span> <span class="mi">36</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nl">reserved</span>        <span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nl">DBM</span>             <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>   <span class="c1">// Dirty bit modifier
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="nl">Contiguous</span>      <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nl">PXN</span>             <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>   <span class="c1">// Privileged execute-never
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="nl">UXN</span>             <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>   <span class="c1">// Execute never
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="nl">soft_reserved</span>   <span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nl">PBHA</span>            <span class="p">:</span> <span class="mi">4</span><span class="p">,</span>   <span class="c1">// Page based hardware attributes
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="nl">ignored</span>         <span class="p">:</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="n">l3_page</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">u64</span> <span class="n">pte</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="kt">pte_t</span><span class="p">;</span> <span class="c1">// 页表项联合体，增加代码可读性
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">pte_t</span> <span class="n">ent</span><span class="p">[</span><span class="n">PTP_ENTRIES</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="kt">ptp_t</span><span class="p">;</span> <span class="c1">// 页表结构体，每个页表有512个页表项
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">cur_ptp: 当前页表地址
</span></span></span><span class="line"><span class="cl"><span class="cm">level: 当前页表级别
</span></span></span><span class="line"><span class="cl"><span class="cm">va: 虚拟地址
</span></span></span><span class="line"><span class="cl"><span class="cm">next_ptp: 下一级页表地址
</span></span></span><span class="line"><span class="cl"><span class="cm">pte: 返回的页表项地址
</span></span></span><span class="line"><span class="cl"><span class="cm">alloc: 如果页表项不合法时是否分配
</span></span></span><span class="line"><span class="cl"><span class="cm">rss: 用于记录内存占用
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">get_next_ptp</span><span class="p">(</span><span class="kt">ptp_t</span> <span class="o">*</span><span class="n">cur_ptp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">level</span><span class="p">,</span> <span class="kt">vaddr_t</span> <span class="n">va</span><span class="p">,</span> <span class="kt">ptp_t</span> <span class="o">**</span><span class="n">next_ptp</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="kt">pte_t</span> <span class="o">**</span><span class="n">pte</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">alloc</span><span class="p">,</span> <span class="n">__maybe_unused</span> <span class="kt">long</span> <span class="o">*</span><span class="n">rss</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">u32</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">pte_t</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">cur_ptp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="o">-</span><span class="n">ENOMAPPING</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">switch</span> <span class="p">(</span><span class="n">level</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">L0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">index</span> <span class="o">=</span> <span class="nf">GET_L0_INDEX</span><span class="p">(</span><span class="n">va</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">L1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">index</span> <span class="o">=</span> <span class="nf">GET_L1_INDEX</span><span class="p">(</span><span class="n">va</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">L2</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">index</span> <span class="o">=</span> <span class="nf">GET_L2_INDEX</span><span class="p">(</span><span class="n">va</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">L3</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">index</span> <span class="o">=</span> <span class="nf">GET_L3_INDEX</span><span class="p">(</span><span class="n">va</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                <span class="nf">BUG</span><span class="p">(</span><span class="s">&#34;unexpected level</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">entry</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">cur_ptp</span><span class="o">-&gt;</span><span class="n">ent</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span> <span class="c1">// 获取页表项
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="nf">IS_PTE_INVALID</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">pte</span><span class="p">))</span> <span class="p">{</span> <span class="c1">// ... 省略n行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   		<span class="c1">// 获取页表项对应的页表地址（也有可能是一个块）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">*</span><span class="n">next_ptp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">ptp_t</span> <span class="o">*</span><span class="p">)</span><span class="nf">GET_NEXT_PTP</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span> <span class="c1">// 返回下一级页表地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">*</span><span class="n">pte</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span> <span class="c1">// 将获取到的页表项返回
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="nf">IS_PTE_TABLE</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">pte</span><span class="p">))</span> <span class="c1">// 判断是块还是页表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">return</span> <span class="n">NORMAL_PTP</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">BLOCK_PTP</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>题解：</strong></p>
<blockquote>
<p><code>query_in_pgtbl</code>函数， 将虚拟地址翻译成物理地址，并返回存储该物理地址的页表项</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">pgtbl: L0页表地址
</span></span></span><span class="line"><span class="cl"><span class="cm">va: 虚拟地址
</span></span></span><span class="line"><span class="cl"><span class="cm">pa: 物理地址
</span></span></span><span class="line"><span class="cl"><span class="cm">entry: 存储该物理地址的页表项
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">query_in_pgtbl</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">pgtbl</span><span class="p">,</span> <span class="kt">vaddr_t</span> <span class="n">va</span><span class="p">,</span> <span class="kt">paddr_t</span> <span class="o">*</span><span class="n">pa</span><span class="p">,</span> <span class="kt">pte_t</span> <span class="o">**</span><span class="n">entry</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* LAB 2 TODO 4 BEGIN */</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">         * Hint: Walk through each level of page table using `get_next_ptp`,
</span></span></span><span class="line"><span class="cl"><span class="cm">         * return the pa and pte until a L2/L3 block or page, return
</span></span></span><span class="line"><span class="cl"><span class="cm">         * `-ENOMAPPING` if the va is not mapped.
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* BLANK BEGIN */</span>
</span></span><span class="line"><span class="cl">        <span class="kt">ptp_t</span> <span class="o">*</span><span class="n">l0_ptp</span><span class="p">,</span> <span class="o">*</span><span class="n">l1_ptp</span><span class="p">,</span> <span class="o">*</span><span class="n">l2_ptp</span><span class="p">,</span> <span class="o">*</span><span class="n">l3_ptp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">ptp_t</span> <span class="o">*</span><span class="n">phys_p</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">pte_t</span> <span class="o">*</span><span class="n">pte</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    	<span class="c1">// 翻译0级页表，获得1级页表地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">l0_ptp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">ptp_t</span> <span class="o">*</span><span class="p">)</span><span class="n">pgtbl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">ret</span> <span class="o">=</span> <span class="nf">get_next_ptp</span><span class="p">(</span><span class="n">l0_ptp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">va</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">l1_ptp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pte</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BUG_ON</span><span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">NORMAL_PTP</span><span class="p">);</span> <span class="c1">// 题目描述是以4KB为粒度，所以不考虑块地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    	<span class="c1">// 翻译1级页表，获得2级页表地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">ret</span> <span class="o">=</span> <span class="nf">get_next_ptp</span><span class="p">(</span><span class="n">l1_ptp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">va</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">l2_ptp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pte</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BUG_ON</span><span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">NORMAL_PTP</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// 翻译2级页表，获得3级页表地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">ret</span> <span class="o">=</span> <span class="nf">get_next_ptp</span><span class="p">(</span><span class="n">l2_ptp</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">va</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">l3_ptp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pte</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">       	<span class="nf">BUG_ON</span><span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">NORMAL_PTP</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    	<span class="c1">// 翻译3级页表，获得物理页地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">ret</span> <span class="o">=</span> <span class="nf">get_next_ptp</span><span class="p">(</span><span class="n">l3_ptp</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">va</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phys_p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pte</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>      
</span></span><span class="line"><span class="cl">     	<span class="c1">// 此时phys_p为物理页地址，而操作系统也只能通过虚拟地址访问内存
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>     	<span class="c1">// get_next_ptp默认将物理地址转为虚拟地址返回
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>     	<span class="c1">// 所以我们要将得到的虚拟地址先转为物理地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>     	<span class="c1">// 最后，我们要再加上偏移值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">pa</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">*</span><span class="n">pa</span> <span class="o">=</span> <span class="nf">virt_to_phys</span><span class="p">(</span><span class="n">phys_p</span><span class="p">)</span> <span class="o">+</span> <span class="nf">GET_VA_OFFSET_L3</span><span class="p">(</span><span class="n">va</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">*</span><span class="n">entry</span> <span class="o">=</span> <span class="n">pte</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* BLANK END */</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* LAB 2 TODO 4 END */</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p><code>map_range_in_pgtbl_common</code>函数，建立页表映射</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">pgtbl: L0页表地址
</span></span></span><span class="line"><span class="cl"><span class="cm">va: 虚拟地址(起始)
</span></span></span><span class="line"><span class="cl"><span class="cm">pa: 物理地址(起始)
</span></span></span><span class="line"><span class="cl"><span class="cm">len: 映射大小
</span></span></span><span class="line"><span class="cl"><span class="cm">flag: 权限标识，在set_pte_flags中用到
</span></span></span><span class="line"><span class="cl"><span class="cm">kind: 页表类型，0代表用户态页表，1代表内核页表
</span></span></span><span class="line"><span class="cl"><span class="cm">rss: 跟踪内存占用
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">map_range_in_pgtbl_common</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">pgtbl</span><span class="p">,</span> <span class="kt">vaddr_t</span> <span class="n">va</span><span class="p">,</span> <span class="kt">paddr_t</span> <span class="n">pa</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                     <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="kt">vmr_prop_t</span> <span class="n">flags</span><span class="p">,</span> <span class="kt">int</span> <span class="n">kind</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                     <span class="n">__maybe_unused</span> <span class="kt">long</span> <span class="o">*</span><span class="n">rss</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* LAB 2 TODO 4 BEGIN */</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">         * Hint: Walk through each level of page table using `get_next_ptp`,
</span></span></span><span class="line"><span class="cl"><span class="cm">         * create new page table page if necessary, fill in the final level
</span></span></span><span class="line"><span class="cl"><span class="cm">         * pte with the help of `set_pte_flags`. Iterate until all pages are
</span></span></span><span class="line"><span class="cl"><span class="cm">         * mapped.
</span></span></span><span class="line"><span class="cl"><span class="cm">         * Since we are adding new mappings, there is no need to flush TLBs.
</span></span></span><span class="line"><span class="cl"><span class="cm">         * Return 0 on success.
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* BLANK BEGIN */</span>
</span></span><span class="line"><span class="cl">        <span class="n">u64</span> <span class="n">total_page_cnt</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">ptp_t</span> <span class="o">*</span><span class="n">l0_ptp</span><span class="p">,</span> <span class="o">*</span><span class="n">l1_ptp</span><span class="p">,</span> <span class="o">*</span><span class="n">l2_ptp</span><span class="p">,</span> <span class="o">*</span><span class="n">l3_ptp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">pte_t</span> <span class="o">*</span><span class="n">pte</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">pte_idx</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">BUG_ON</span><span class="p">(</span><span class="n">pgtbl</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    	<span class="c1">// 由于映射单位是按页来分的，页内偏移量应该为0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">BUG_ON</span><span class="p">(</span><span class="n">va</span> <span class="o">%</span> <span class="n">PAGE_SIZE</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">		<span class="c1">// 计算需要的页表数量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">total_page_cnt</span> <span class="o">=</span> <span class="n">len</span> <span class="o">/</span> <span class="n">PAGE_SIZE</span> <span class="o">+</span> <span class="p">(</span><span class="n">len</span> <span class="o">%</span> <span class="n">PAGE_SIZE</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">l0_ptp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">ptp_t</span> <span class="o">*</span><span class="p">)</span><span class="n">pgtbl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    	<span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">while</span> <span class="p">(</span><span class="n">total_page_cnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            	<span class="c1">// 先一路翻译到l3页表，如果页表不存在则先分配一个页表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">ret</span> <span class="o">=</span> <span class="nf">get_next_ptp</span><span class="p">(</span><span class="n">l0_ptp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">va</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">l1_ptp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pte</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">rss</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="nf">BUG_ON</span><span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">NORMAL_PTP</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">                <span class="n">ret</span> <span class="o">=</span> <span class="nf">get_next_ptp</span><span class="p">(</span><span class="n">l1_ptp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">va</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">l2_ptp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pte</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">rss</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="nf">BUG_ON</span><span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">NORMAL_PTP</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">ret</span> <span class="o">=</span> <span class="nf">get_next_ptp</span><span class="p">(</span><span class="n">l2_ptp</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">va</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">l3_ptp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pte</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">rss</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="nf">BUG_ON</span><span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">NORMAL_PTP</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            	<span class="c1">// 获取页表项的位置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">pte_idx</span> <span class="o">=</span> <span class="nf">GET_L3_INDEX</span><span class="p">(</span><span class="n">va</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            	<span class="c1">// 从该位置开始循环地分配页表项
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">pte_idx</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PTP_ENTRIES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          				<span class="c1">// 配置l3页表项
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="kt">pte_t</span> <span class="n">new_pte</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                        <span class="n">new_pte</span><span class="p">.</span><span class="n">pte</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// 这里是为了初始化
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="n">new_pte</span><span class="p">.</span><span class="n">l3_page</span><span class="p">.</span><span class="n">is_valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                        <span class="n">new_pte</span><span class="p">.</span><span class="n">l3_page</span><span class="p">.</span><span class="n">is_page</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    	<span class="c1">// 获取页表项映射的物理地址位置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="n">new_pte</span><span class="p">.</span><span class="n">l3_page</span><span class="p">.</span><span class="n">pfn</span> <span class="o">=</span> <span class="n">pa</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    	<span class="c1">// 设置内存权限
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="nf">set_pte_flags</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_pte</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">kind</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    	<span class="c1">// 赋值给l3页表对应的位置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="n">l3_ptp</span><span class="o">-&gt;</span><span class="n">ent</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pte</span> <span class="o">=</span> <span class="n">new_pte</span><span class="p">.</span><span class="n">pte</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">						
</span></span><span class="line"><span class="cl">                    	<span class="c1">// 这里是为了保证下一次循环能够正确的得到起始的va和pa
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="n">va</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                        <span class="n">pa</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="p">(</span><span class="n">rss</span><span class="p">)</span> <span class="c1">// 记录内存占用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                                <span class="o">*</span><span class="n">rss</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                        <span class="n">total_page_cnt</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// 所需页表数减1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="k">if</span> <span class="p">(</span><span class="n">total_page_cnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">// 如果已经分配完毕则退出
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* BLANK END */</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* LAB 2 TODO 4 END */</span>
</span></span><span class="line"><span class="cl">    	<span class="c1">// 用于保障共享资源的更新
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">dsb</span><span class="p">(</span><span class="n">ishst</span><span class="p">);</span> <span class="c1">// 确保所有之前的内存操作已完成
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">isb</span><span class="p">();</span> <span class="c1">// 刷新指令流水线
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p><code>unmap_range_in_pgtbl</code>函数，取消内存映射，是<code>map_range_in_pgtbl_common</code>的相反操作，我们只需要复制之后进行修改就好了</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">unmap_range_in_pgtbl</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">pgtbl</span><span class="p">,</span> <span class="kt">vaddr_t</span> <span class="n">va</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                         <span class="n">__maybe_unused</span> <span class="kt">long</span> <span class="o">*</span><span class="n">rss</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* LAB 2 TODO 4 BEGIN */</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">         * Hint: Walk through each level of page table using `get_next_ptp`,
</span></span></span><span class="line"><span class="cl"><span class="cm">         * mark the final level pte as invalid. Iterate until all pages are
</span></span></span><span class="line"><span class="cl"><span class="cm">         * unmapped.
</span></span></span><span class="line"><span class="cl"><span class="cm">         * You don&#39;t need to flush tlb here since tlb is now flushed after
</span></span></span><span class="line"><span class="cl"><span class="cm">         * this function is called.
</span></span></span><span class="line"><span class="cl"><span class="cm">         * Return 0 on success.
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* BLANK BEGIN */</span>
</span></span><span class="line"><span class="cl">        <span class="n">u64</span> <span class="n">total_page_cnt</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">ptp_t</span> <span class="o">*</span><span class="n">l0_ptp</span><span class="p">,</span> <span class="o">*</span><span class="n">l1_ptp</span><span class="p">,</span> <span class="o">*</span><span class="n">l2_ptp</span><span class="p">,</span> <span class="o">*</span><span class="n">l3_ptp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">pte_t</span> <span class="o">*</span><span class="n">pte</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">pte_idx</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">BUG_ON</span><span class="p">(</span><span class="n">pgtbl</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BUG_ON</span><span class="p">(</span><span class="n">va</span> <span class="o">%</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">total_page_cnt</span> <span class="o">=</span> <span class="n">len</span> <span class="o">/</span> <span class="n">PAGE_SIZE</span> <span class="o">+</span> <span class="p">(</span><span class="n">len</span> <span class="o">%</span> <span class="n">PAGE_SIZE</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">l0_ptp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">ptp_t</span> <span class="o">*</span><span class="p">)</span><span class="n">pgtbl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="p">(</span><span class="n">total_page_cnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">ret</span> <span class="o">=</span> <span class="nf">get_next_ptp</span><span class="p">(</span><span class="n">l0_ptp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">va</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">l1_ptp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pte</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="n">rss</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOMAPPING</span><span class="p">)</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl">                <span class="c1">// 这里与之前不同，当l0_ptp为0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// 或者对应的页表项不合法的时候才会返回-ENOMAPPING
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// 这意味着对应的内存已经被取消映射
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// 我们只需要保证当前函数逻辑能继续运行下去就好
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="n">total_page_cnt</span> <span class="o">-=</span> <span class="n">L0_PER_ENTRY_PAGES</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                        <span class="n">va</span> <span class="o">+=</span> <span class="n">L0_PER_ENTRY_PAGES</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="p">(</span><span class="n">rss</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                <span class="o">*</span><span class="n">rss</span> <span class="o">-=</span> <span class="n">L0_PER_ENTRY_PAGES</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                        <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="n">ret</span> <span class="o">=</span> <span class="nf">get_next_ptp</span><span class="p">(</span><span class="n">l1_ptp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">va</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">l2_ptp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pte</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="n">rss</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOMAPPING</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// 同上
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="n">total_page_cnt</span> <span class="o">-=</span> <span class="n">L1_PER_ENTRY_PAGES</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                        <span class="n">va</span> <span class="o">+=</span> <span class="n">L1_PER_ENTRY_PAGES</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="p">(</span><span class="n">rss</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                <span class="o">*</span><span class="n">rss</span> <span class="o">-=</span> <span class="n">L1_PER_ENTRY_PAGES</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                        <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="n">ret</span> <span class="o">=</span> <span class="nf">get_next_ptp</span><span class="p">(</span><span class="n">l2_ptp</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">va</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">l3_ptp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pte</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="n">rss</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOMAPPING</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// 同上
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="n">total_page_cnt</span> <span class="o">-=</span> <span class="n">L2_PER_ENTRY_PAGES</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                        <span class="n">va</span> <span class="o">+=</span> <span class="n">L2_PER_ENTRY_PAGES</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="p">(</span><span class="n">rss</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                <span class="o">*</span><span class="n">rss</span> <span class="o">-=</span> <span class="n">L2_PER_ENTRY_PAGES</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                        <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            	<span class="c1">// 获取l3页表项的下标
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">pte_idx</span> <span class="o">=</span> <span class="nf">GET_L3_INDEX</span><span class="p">(</span><span class="n">va</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">pte_idx</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PTP_ENTRIES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="n">l3_ptp</span><span class="o">-&gt;</span><span class="n">ent</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pte</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// 直接将所有值都设置为0即可
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    	<span class="c1">// 同 map_range_in_pgtbl_common
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="n">va</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="p">(</span><span class="n">rss</span><span class="p">)</span> <span class="c1">// 记录内存占用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                                <span class="o">*</span><span class="n">rss</span> <span class="o">-=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                        <span class="n">total_page_cnt</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="p">(</span><span class="n">total_page_cnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* BLANK END */</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* LAB 2 TODO 4 END */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">dsb</span><span class="p">(</span><span class="n">ishst</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">isb</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p><code>mprotect_in_pgtbl</code>函数，跟上面一样，只需要改一两句代码，没什么好讲的</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">mprotect_in_pgtbl</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">pgtbl</span><span class="p">,</span> <span class="kt">vaddr_t</span> <span class="n">va</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="kt">vmr_prop_t</span> <span class="n">flags</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* LAB 2 TODO 4 BEGIN */</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">         * Hint: Walk through each level of page table using `get_next_ptp`,
</span></span></span><span class="line"><span class="cl"><span class="cm">         * modify the permission in the final level pte using `set_pte_flags`.
</span></span></span><span class="line"><span class="cl"><span class="cm">         * The `kind` argument of `set_pte_flags` should always be `USER_PTE`.
</span></span></span><span class="line"><span class="cl"><span class="cm">         * Return 0 on success.
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* BLANK BEGIN */</span>
</span></span><span class="line"><span class="cl">        <span class="n">u64</span> <span class="n">total_page_cnt</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">ptp_t</span> <span class="o">*</span><span class="n">l0_ptp</span><span class="p">,</span> <span class="o">*</span><span class="n">l1_ptp</span><span class="p">,</span> <span class="o">*</span><span class="n">l2_ptp</span><span class="p">,</span> <span class="o">*</span><span class="n">l3_ptp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">pte_t</span> <span class="o">*</span><span class="n">pte</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">pte_idx</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">BUG_ON</span><span class="p">(</span><span class="n">pgtbl</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">BUG_ON</span><span class="p">(</span><span class="n">va</span> <span class="o">%</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">total_page_cnt</span> <span class="o">=</span> <span class="n">len</span> <span class="o">/</span> <span class="n">PAGE_SIZE</span> <span class="o">+</span> <span class="p">(</span><span class="n">len</span> <span class="o">%</span> <span class="n">PAGE_SIZE</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">l0_ptp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">ptp_t</span> <span class="o">*</span><span class="p">)</span><span class="n">pgtbl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="p">(</span><span class="n">total_page_cnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">ret</span> <span class="o">=</span> <span class="nf">get_next_ptp</span><span class="p">(</span><span class="n">l0_ptp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">va</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">l1_ptp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pte</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOMAPPING</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="n">total_page_cnt</span> <span class="o">-=</span> <span class="n">L0_PER_ENTRY_PAGES</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                        <span class="n">va</span> <span class="o">+=</span> <span class="n">L0_PER_ENTRY_PAGES</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                        <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="n">ret</span> <span class="o">=</span> <span class="nf">get_next_ptp</span><span class="p">(</span><span class="n">l1_ptp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">va</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">l2_ptp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pte</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOMAPPING</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="n">total_page_cnt</span> <span class="o">-=</span> <span class="n">L1_PER_ENTRY_PAGES</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                        <span class="n">va</span> <span class="o">+=</span> <span class="n">L1_PER_ENTRY_PAGES</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                        <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="n">ret</span> <span class="o">=</span> <span class="nf">get_next_ptp</span><span class="p">(</span><span class="n">l2_ptp</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">va</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">l3_ptp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pte</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOMAPPING</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="n">total_page_cnt</span> <span class="o">-=</span> <span class="n">L2_PER_ENTRY_PAGES</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                        <span class="n">va</span> <span class="o">+=</span> <span class="n">L2_PER_ENTRY_PAGES</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                        <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="n">pte_idx</span> <span class="o">=</span> <span class="nf">GET_L3_INDEX</span><span class="p">(</span><span class="n">va</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">pte_idx</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PTP_ENTRIES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="nf">set_pte_flags</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">l3_ptp</span><span class="o">-&gt;</span><span class="n">ent</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">flags</span><span class="p">,</span> <span class="n">USER_PTE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                        <span class="n">va</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                        <span class="n">total_page_cnt</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="p">(</span><span class="n">total_page_cnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* BLANK END */</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* LAB 2 TODO 4 END */</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="挑战题7">挑战题7
</h2><p>使用前面实现的 <code>page_table.c</code> 中的函数，在内核启动后的 <code>main</code> 函数中重新配置内核页表，进行细粒度的映射。</p>
<blockquote>
<p>这题的意思应该是将所有的内核地址都映射到内核页表内，这需要根据lab1中的介绍来获取内核地址范围。但由于笔者实力不够，还不太明白这题的意思，并且没有多少时间来钻研这个，所以并没有进行实现</p>
</blockquote>
<h2 id="练习题-8-9-10">练习题 8, 9, 10
</h2><ul>
<li>完成 <code>kernel/arch/aarch64/irq/pgfault.c</code> 中的 <code>do_page_fault</code> 函数中的 <code>LAB 2 TODO 5</code> 部分，将缺页异常转发给 <code>handle_trans_fault</code> 函数。</li>
<li>完成 <code>kernel/mm/vmspace.c</code> 中的 <code>find_vmr_for_va</code> 函数中的 <code>LAB 2 TODO 6</code> 部分，找到一个虚拟地址找在其虚拟地址空间中的 VMR。</li>
<li>完成 <code>kernel/mm/pgfault_handler.c</code> 中的 <code>handle_trans_fault</code> 函数中的 <code>LAB 2 TODO 7</code> 部分（函数内共有 3 处填空，不要遗漏），实现 <code>PMO_SHM</code> 和 <code>PMO_ANONYM</code> 的按需物理页分配。你可以阅读代码注释，调用你之前见到过的相关函数来实现功能。</li>
</ul>
<p><strong>以上三题基本等于一题，所以放一起看</strong></p>
<blockquote>
<p><code>do_page_fault</code> 函数</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">do_page_fault</span><span class="p">(</span><span class="n">u64</span> <span class="n">esr</span><span class="p">,</span> <span class="n">u64</span> <span class="n">fault_ins_addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">fix_addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">vaddr_t</span> <span class="n">fault_addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">fsc</span><span class="p">;</span> <span class="c1">// fault status code
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">int</span> <span class="n">wnr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">fault_addr</span> <span class="o">=</span> <span class="nf">get_fault_addr</span><span class="p">();</span> <span class="c1">// 获取缺页异常的地址时要访问的地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">fsc</span> <span class="o">=</span> <span class="nf">GET_ESR_EL1_FSC</span><span class="p">(</span><span class="n">esr</span><span class="p">);</span>	<span class="c1">// 获取缺页异常类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">switch</span> <span class="p">(</span><span class="n">fsc</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DFSC_TRANS_FAULT_L0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DFSC_TRANS_FAULT_L1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DFSC_TRANS_FAULT_L2</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DFSC_TRANS_FAULT_L3</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="cm">/* LAB 2 TODO 5 BEGIN */</span>
</span></span><span class="line"><span class="cl">                <span class="cm">/* BLANK BEGIN */</span>
</span></span><span class="line"><span class="cl">            	<span class="c1">// 根据上下文，这是一个翻译异常，所以我们参考下面的权限异常来调用异常处理函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">ret</span> <span class="o">=</span> <span class="nf">handle_trans_fault</span><span class="p">(</span><span class="n">current_thread</span><span class="o">-&gt;</span><span class="n">vmspace</span><span class="p">,</span> <span class="n">fault_addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="cm">/* BLANK END */</span>
</span></span><span class="line"><span class="cl">                <span class="cm">/* LAB 2 TODO 5 END */</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="cm">/* The trap happens in the kernel */</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&lt;</span> <span class="n">SYNC_EL0_64</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                <span class="k">goto</span> <span class="n">no_context</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                        <span class="nf">kinfo</span><span class="p">(</span><span class="s">&#34;do_page_fault: faulting ip is 0x%lx (real IP),&#34;</span>
</span></span><span class="line"><span class="cl">                              <span class="s">&#34;faulting address is 0x%lx,&#34;</span>
</span></span><span class="line"><span class="cl">                              <span class="s">&#34;fsc is trans_fault (0b%b),&#34;</span>
</span></span><span class="line"><span class="cl">                              <span class="s">&#34;type is %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                              <span class="n">fault_ins_addr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                              <span class="n">fault_addr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                              <span class="n">fsc</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                              <span class="n">type</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                        <span class="nf">kprint_vmr</span><span class="p">(</span><span class="n">current_thread</span><span class="o">-&gt;</span><span class="n">vmspace</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                        <span class="nf">kinfo</span><span class="p">(</span><span class="s">&#34;current_cap_group is %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                              <span class="n">current_cap_group</span><span class="o">-&gt;</span><span class="n">cap_group_name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                        <span class="nf">sys_exit_group</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ...省略n行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p><code>find_vmr_for_va</code> 函数，在vmspace中查找相应vmr</p>
</blockquote>
<p>​	<strong>前置代码：</strong></p>
<ul>
<li>对应的结构体定义</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">vmregion</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="n">list_head</span> <span class="n">list_node</span><span class="p">;</span> <span class="cm">/* As one node of the vmr_list */</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="n">rb_node</span> <span class="n">tree_node</span><span class="p">;</span> <span class="cm">/* As one node of the vmr_tree */</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* As one node of the pmo&#39;s mapping_list */</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="n">list_head</span> <span class="n">mapping_list_node</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="n">vmspace</span> <span class="o">*</span><span class="n">vmspace</span><span class="p">;</span> <span class="c1">// 所在用户态空间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">vaddr_t</span> <span class="n">start</span><span class="p">;</span> <span class="c1">// 地址段起始位置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">size_t</span> <span class="n">size</span><span class="p">;</span> <span class="c1">// 地址段大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="cm">/* Offset of underlying pmo */</span>
</span></span><span class="line"><span class="cl">        <span class="kt">size_t</span> <span class="n">offset</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">        <span class="kt">vmr_prop_t</span> <span class="n">perm</span><span class="p">;</span> <span class="c1">// 地址段权限
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">struct</span> <span class="n">pmobject</span> <span class="o">*</span><span class="n">pmo</span><span class="p">;</span> <span class="c1">// 物理内存对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">struct</span> <span class="n">list_head</span> <span class="n">cow_private_pages</span><span class="p">;</span> <span class="c1">// 由copy-on-write使用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* This struct represents one virtual address space */</span>
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">vmspace</span> <span class="p">{</span> <span class="c1">// 用户态空间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="cm">/* List head of vmregion (vmr_list) */</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="n">list_head</span> <span class="n">vmr_list</span><span class="p">;</span> <span class="c1">// 用户态地址段链表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="cm">/* rbtree root node of vmregion (vmr_tree) */</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="n">rb_root</span> <span class="n">vmr_tree</span><span class="p">;</span> <span class="c1">// 用户态地址段红黑树，用于快速查找相应地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* Root page table */</span>
</span></span><span class="line"><span class="cl">        <span class="kt">void</span> <span class="o">*</span><span class="n">pgtbl</span><span class="p">;</span> <span class="c1">// L0页表地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="cm">/* Address space ID for avoiding TLB conflicts */</span>
</span></span><span class="line"><span class="cl">        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pcid</span><span class="p">;</span> <span class="c1">// 用户id
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* The lock for manipulating vmregions */</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="n">lock</span> <span class="n">vmspace_lock</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">        <span class="cm">/* The lock for manipulating the page table */</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="n">lock</span> <span class="n">pgtbl_lock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">         * For TLB flushing:
</span></span></span><span class="line"><span class="cl"><span class="cm">         * Record the all the CPU that a vmspace ran on.
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span>
</span></span><span class="line"><span class="cl">        <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">history_cpus</span><span class="p">[</span><span class="n">PLAT_CPU_NUM</span><span class="p">];</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="n">vmregion</span> <span class="o">*</span><span class="n">heap_boundary_vmr</span><span class="p">;</span> <span class="c1">// 没用到，感兴趣可以通过vsc的搜索功能看一下用法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* Records size of memory mapped. Protected by pgtbl_lock. */</span>
</span></span><span class="line"><span class="cl">        <span class="kt">long</span> <span class="n">rss</span><span class="p">;</span> <span class="c1">// 内存管理标志
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>红黑树的查询函数</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="nf">rb_search</span><span class="p">(</span><span class="k">struct</span> <span class="n">rb_root</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                          <span class="n">comp_key_func</span> <span class="n">cmp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">cur</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">root_node</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">cmp_ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="p">(</span><span class="n">cur</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">cmp_ret</span> <span class="o">=</span> <span class="nf">cmp</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">cur</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">cmp_ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="n">cur</span> <span class="o">=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">left_child</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmp_ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="n">cur</span> <span class="o">=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">right_child</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="k">return</span> <span class="n">cur</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>​	<strong>题解</strong>：</p>
<blockquote>
<p>我们其实不需要了解太多相关信息，只需要知道怎么查找就好了，这里使用的是红黑树来查找，根据内核实现的红黑树查找函数，以及已经实现了的比较函数<code>cmp_vmr_and_va</code>和<code>rb_entry</code>，即可完成题目</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">__maybe_unused</span> <span class="k">struct</span> <span class="n">vmregion</span> <span class="o">*</span><span class="nf">find_vmr_for_va</span><span class="p">(</span><span class="k">struct</span> <span class="n">vmspace</span> <span class="o">*</span><span class="n">vmspace</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                <span class="kt">vaddr_t</span> <span class="n">addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* LAB 2 TODO 6 BEGIN */</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* Hint: Find the corresponding vmr for @addr in @vmspace */</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* BLANK BEGIN */</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="n">vmregion</span> <span class="o">*</span><span class="n">vmr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="n">rb_node</span> <span class="o">*</span><span class="n">node</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">node</span> <span class="o">=</span> <span class="nf">rb_search</span><span class="p">(</span> <span class="c1">// 查找相应的节点
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">&amp;</span><span class="p">(</span><span class="n">vmspace</span><span class="o">-&gt;</span><span class="n">vmr_tree</span><span class="p">),</span> <span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">addr</span><span class="p">,</span> <span class="n">cmp_vmr_and_va</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nf">unlikely</span><span class="p">(</span><span class="n">node</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span> <span class="c1">// 没找到返回NULL
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">vmr</span> <span class="o">=</span> <span class="nf">rb_entry</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vmregion</span><span class="p">,</span> <span class="n">tree_node</span><span class="p">);</span> <span class="c1">// 获取节点所在结构体
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="n">vmr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* BLANK END */</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* LAB 2 TODO 6 END */</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p><code>handle_trans_fault</code> 函数</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">handle_trans_fault</span><span class="p">(</span><span class="k">struct</span> <span class="n">vmspace</span> <span class="o">*</span><span class="n">vmspace</span><span class="p">,</span> <span class="kt">vaddr_t</span> <span class="n">fault_addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="n">vmregion</span> <span class="o">*</span><span class="n">vmr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="n">pmobject</span> <span class="o">*</span><span class="n">pmo</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">paddr_t</span> <span class="n">pa</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">index</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">         * Grab lock here.
</span></span></span><span class="line"><span class="cl"><span class="cm">         * Because two threads (in same process) on different cores
</span></span></span><span class="line"><span class="cl"><span class="cm">         * may fault on the same page, so we need to prevent them
</span></span></span><span class="line"><span class="cl"><span class="cm">         * from adding the same mapping twice.
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span>
</span></span><span class="line"><span class="cl">        <span class="nf">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vmspace</span><span class="o">-&gt;</span><span class="n">vmspace_lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">vmr</span> <span class="o">=</span> <span class="nf">find_vmr_for_va</span><span class="p">(</span><span class="n">vmspace</span><span class="p">,</span> <span class="n">fault_addr</span><span class="p">);</span> <span class="c1">// 查找对应vmr
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">vmr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// 如果为空则该地址不合法，直接退出
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nf">kinfo</span><span class="p">(</span><span class="s">&#34;handle_trans_fault: no vmr found for va 0x%lx!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                      <span class="n">fault_addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="nf">dump_pgfault_error</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vmspace</span><span class="o">-&gt;</span><span class="n">vmspace_lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#if defined(CHCORE_ARCH_AARCH64) || defined(CHCORE_ARCH_SPARC)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>                <span class="cm">/* kernel fault fixup is only supported on AArch64 and Sparc */</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>                <span class="nf">sys_exit_group</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="nf">BUG</span><span class="p">(</span><span class="s">&#34;should not reach here&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">pmo</span> <span class="o">=</span> <span class="n">vmr</span><span class="o">-&gt;</span><span class="n">pmo</span><span class="p">;</span> <span class="c1">// 获取物理内存对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="cm">/* Get the offset in the pmo for faulting addr */</span>
</span></span><span class="line"><span class="cl">        <span class="n">offset</span> <span class="o">=</span> <span class="nf">ROUND_DOWN</span><span class="p">(</span><span class="n">fault_addr</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="o">-</span> <span class="n">vmr</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">+</span> <span class="n">vmr</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">vmr_prop_t</span> <span class="n">perm</span> <span class="o">=</span> <span class="n">vmr</span><span class="o">-&gt;</span><span class="n">perm</span><span class="p">;</span> <span class="c1">// 获取权限记录
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">switch</span> <span class="p">(</span><span class="n">pmo</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// 根据内存对象类型进行处理
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">case</span> <span class="nl">PMO_ANONYM</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">PMO_SHM</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="cm">/* Boundary check */</span>
</span></span><span class="line"><span class="cl">                <span class="nf">BUG_ON</span><span class="p">(</span><span class="n">offset</span> <span class="o">&gt;=</span> <span class="n">pmo</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="cm">/* Get the index in the pmo radix for faulting addr */</span>
</span></span><span class="line"><span class="cl">                <span class="n">index</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">/</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">				<span class="c1">// 处理fault_addr，去除页内偏移以便后续处理
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">fault_addr</span> <span class="o">=</span> <span class="nf">ROUND_DOWN</span><span class="p">(</span><span class="n">fault_addr</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="n">pa</span> <span class="o">=</span> <span class="nf">get_page_from_pmo</span><span class="p">(</span><span class="n">pmo</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span> <span class="c1">// 从pmo中获取物理地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">if</span> <span class="p">(</span><span class="n">pa</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// 如果地址为空，则为未分配，我们直接分配即可
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">                         * Not committed before. Then, allocate the physical
</span></span></span><span class="line"><span class="cl"><span class="cm">                         * page.
</span></span></span><span class="line"><span class="cl"><span class="cm">                         */</span>
</span></span><span class="line"><span class="cl">                        <span class="cm">/* LAB 2 TODO 7 BEGIN */</span>
</span></span><span class="line"><span class="cl">                        <span class="cm">/* BLANK BEGIN */</span>
</span></span><span class="line"><span class="cl">                        <span class="cm">/* Hint: Allocate a physical page and clear it to 0. */</span>
</span></span><span class="line"><span class="cl">                        <span class="kt">void</span> <span class="o">*</span><span class="n">new_va</span> <span class="o">=</span> <span class="nf">get_pages</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="c1">// 获取一个页
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="nf">BUG_ON</span><span class="p">(</span><span class="n">new_va</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                        <span class="n">pa</span> <span class="o">=</span> <span class="nf">virt_to_phys</span><span class="p">(</span><span class="n">new_va</span><span class="p">);</span> <span class="c1">// 转化为物理地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="nf">BUG_ON</span><span class="p">(</span><span class="n">pa</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                        <span class="nf">memset</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">new_va</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span> <span class="c1">// 将页内清空
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">                        <span class="cm">/* BLANK END */</span>
</span></span><span class="line"><span class="cl">                        <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">                         * Record the physical page in the radix tree:
</span></span></span><span class="line"><span class="cl"><span class="cm">                         * the offset is used as index in the radix tree
</span></span></span><span class="line"><span class="cl"><span class="cm">                         */</span>
</span></span><span class="line"><span class="cl">                        <span class="nf">kdebug</span><span class="p">(</span><span class="s">&#34;commit: index: %ld, 0x%lx</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">pa</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                        <span class="nf">commit_page_to_pmo</span><span class="p">(</span><span class="n">pmo</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">pa</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                        <span class="cm">/* Add mapping in the page table */</span>
</span></span><span class="line"><span class="cl">                        <span class="nf">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vmspace</span><span class="o">-&gt;</span><span class="n">pgtbl_lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                        <span class="cm">/* BLANK BEGIN */</span>
</span></span><span class="line"><span class="cl">                    	<span class="c1">// 将地址映射到页表中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="nf">map_range_in_pgtbl</span><span class="p">(</span><span class="n">vmspace</span><span class="o">-&gt;</span><span class="n">pgtbl</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                           <span class="n">fault_addr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                           <span class="n">pa</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                           <span class="n">PAGE_SIZE</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                           <span class="n">perm</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                           <span class="o">&amp;</span><span class="p">(</span><span class="n">vmspace</span><span class="o">-&gt;</span><span class="n">rss</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                        <span class="cm">/* BLANK END */</span>
</span></span><span class="line"><span class="cl">                        <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vmspace</span><span class="o">-&gt;</span><span class="n">pgtbl_lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="p">(</span><span class="n">pmo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">PMO_SHM</span> <span class="o">||</span> <span class="n">pmo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">PMO_ANONYM</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                <span class="cm">/* Add mapping in the page table */</span>
</span></span><span class="line"><span class="cl">                                <span class="nf">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vmspace</span><span class="o">-&gt;</span><span class="n">pgtbl_lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                                <span class="cm">/* BLANK BEGIN */</span>
</span></span><span class="line"><span class="cl">                            	<span class="c1">// 此时内存已被分配，只是没有映射页表，只需要映射页表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                                <span class="nf">map_range_in_pgtbl</span><span class="p">(</span><span class="n">vmspace</span><span class="o">-&gt;</span><span class="n">pgtbl</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                   <span class="n">fault_addr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                   <span class="n">pa</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                   <span class="n">PAGE_SIZE</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                   <span class="n">perm</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                   <span class="o">&amp;</span><span class="p">(</span><span class="n">vmspace</span><span class="o">-&gt;</span><span class="n">rss</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">                                <span class="cm">/* BLANK END */</span>
</span></span><span class="line"><span class="cl">                                <span class="cm">/* LAB 2 TODO 7 END */</span>
</span></span><span class="line"><span class="cl">                                <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vmspace</span><span class="o">-&gt;</span><span class="n">pgtbl_lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">perm</span> <span class="o">&amp;</span> <span class="n">VMR_EXEC</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="nf">arch_flush_cache</span><span class="p">(</span><span class="n">fault_addr</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">SYNC_IDCACHE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="c1">//...省略n行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="挑战题-11">挑战题 11
</h2><p>我们在<code>map_range_in_pgtbl_common</code>、<code>unmap_range_in_pgtbl</code> 函数中预留了没有被使用过的参数<code>rss</code> 用来来统计map映射中实际的物理内存使用量<a class="link" href="https://sjtu-ipads.github.io/OS-Course-Lab/Lab2/page_fault.html#rss"  target="_blank" rel="noopener"
    >1</a>， 你需要修改相关的代码来通过<code>Compute physical memory</code>测试，不实现该挑战题并不影响其他部分功能的实现及测试。如果你想检测是否通过此部分测试，需要修改<code>kernel/config.cmake</code>中<code>CHCORE_KERNEL_PM_USAGE_TEST</code>为ON</p>
<p><strong>题解</strong>：在上面的实现中笔者已经实现了大部分的内存记录，此时只需要稍作修改</p>
<blockquote>
<p><code>get_next_ptp</code> 函数</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nf">IS_PTE_INVALID</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">pte</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">alloc</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMAPPING</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="cm">/* alloc a new page table page */</span>
</span></span><span class="line"><span class="cl">		<span class="kt">ptp_t</span> <span class="o">*</span><span class="n">new_ptp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="kt">paddr_t</span> <span class="n">new_ptp_paddr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="kt">pte_t</span> <span class="n">new_pte_val</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="cm">/* alloc a single physical page as a new page table page
</span></span></span><span class="line"><span class="cl"><span class="cm">		*/</span>
</span></span><span class="line"><span class="cl">		<span class="n">new_ptp</span> <span class="o">=</span> <span class="nf">get_pages</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">new_ptp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="nf">memset</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">new_ptp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">new_ptp_paddr</span> <span class="o">=</span> <span class="nf">virt_to_phys</span><span class="p">((</span><span class="kt">vaddr_t</span><span class="p">)</span><span class="n">new_ptp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">new_pte_val</span><span class="p">.</span><span class="n">pte</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">new_pte_val</span><span class="p">.</span><span class="n">table</span><span class="p">.</span><span class="n">is_valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">new_pte_val</span><span class="p">.</span><span class="n">table</span><span class="p">.</span><span class="n">is_table</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">new_pte_val</span><span class="p">.</span><span class="n">table</span><span class="p">.</span><span class="n">next_table_addr</span> <span class="o">=</span> <span class="n">new_ptp_paddr</span>
</span></span><span class="line"><span class="cl">												<span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="cm">/* same effect as: cur_ptp-&gt;ent[index] = new_pte_val; */</span>
</span></span><span class="line"><span class="cl">		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">pte</span> <span class="o">=</span> <span class="n">new_pte_val</span><span class="p">.</span><span class="n">pte</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 只需要在这里加一个内存记录
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="p">(</span><span class="n">rss</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="o">*</span><span class="n">rss</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p><code>try_release_ptp</code> 函数</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">try_release_ptp</span><span class="p">(</span><span class="kt">ptp_t</span> <span class="o">*</span><span class="n">high_ptp</span><span class="p">,</span> <span class="kt">ptp_t</span> <span class="o">*</span><span class="n">low_ptp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                           <span class="n">__maybe_unused</span> <span class="kt">long</span> <span class="o">*</span><span class="n">rss</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PTP_ENTRIES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">low_ptp</span><span class="o">-&gt;</span><span class="n">ent</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pte</span> <span class="o">!=</span> <span class="n">PTE_DESCRIPTOR_INVALID</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">BUG_ON</span><span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="n">PTP_ENTRIES</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">high_ptp</span><span class="o">-&gt;</span><span class="n">ent</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">pte</span> <span class="o">=</span> <span class="n">PTE_DESCRIPTOR_INVALID</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nf">kfree</span><span class="p">(</span><span class="n">low_ptp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">rss</span><span class="p">)</span> <span class="c1">// 加一个内存记录
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">*</span><span class="n">rss</span> <span class="o">-=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p><code>unmap_range_in_pgtbl</code>函数</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">pte_idx</span> <span class="o">=</span> <span class="nf">GET_L3_INDEX</span><span class="p">(</span><span class="n">va</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">pre_va</span> <span class="o">=</span> <span class="n">va</span><span class="p">;</span> <span class="c1">// 先记录原来的地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">pte_idx</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PTP_ENTRIES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">l3_ptp</span><span class="o">-&gt;</span><span class="n">ent</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pte</span> <span class="o">=</span> <span class="n">PTE_DESCRIPTOR_INVALID</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">va</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">rss</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="o">*</span><span class="n">rss</span> <span class="o">-=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">total_page_cnt</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">total_page_cnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 如果此时已经将所有的页表取消了映射，调用页表回收函数，已经被实现
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nf">recycle_pgtable_entry</span><span class="p">(</span><span class="n">l0_ptp</span><span class="p">,</span> <span class="n">l1_ptp</span><span class="p">,</span> <span class="n">l2_ptp</span><span class="p">,</span> <span class="n">l3_ptp</span><span class="p">,</span> <span class="n">pre_va</span><span class="p">,</span> <span class="n">rss</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 每次大循环都要回收尝试回收一次页表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="n">total_page_cnt</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">// 防止多次调用回收函数导致计算错误，所以要先判断
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">recycle_pgtable_entry</span><span class="p">(</span><span class="n">l0_ptp</span><span class="p">,</span> <span class="n">l1_ptp</span><span class="p">,</span> <span class="n">l2_ptp</span><span class="p">,</span> <span class="n">l3_ptp</span><span class="p">,</span> <span class="n">pre_va</span><span class="p">,</span> <span class="n">rss</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div>
</section>


    <footer class="article-footer">
    

    </footer>


    
        <link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI&#43;WdtXRGWt2kTvGFasHpSy3SV"crossorigin="anonymous"
            ><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"integrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG&#43;vnGctmUb0ZY0l8"crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"integrity="sha384-&#43;VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4&#43;/RRE05"crossorigin="anonymous"
                defer
                >
            </script><script>
    window.addEventListener("DOMContentLoaded", () => {
        renderMathInElement(document.body, {
            delimiters: [
                { left: "$$", right: "$$", display: true },
                { left: "$", right: "$", display: false },
                { left: "\\(", right: "\\)", display: false },
                { left: "\\[", right: "\\]", display: true }
            ],
            ignoredClasses: ["gist"]
        });})
</script>
    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">相关文章</h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="">
    <a href="/blogs/chcore_lab1-%E5%81%9A%E9%A2%98%E7%AC%94%E8%AE%B0/">
        
        

        <div class="article-details">
            <h2 class="article-title">ChCore_lab1 做题笔记</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/blogs/chcore_lab0-%E5%81%9A%E9%A2%98%E7%AC%94%E8%AE%B0/">
        
        

        <div class="article-details">
            <h2 class="article-title">ChCore_lab0 做题笔记</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    <script src="https://utteranc.es/client.js" 
        repo=""
        issue-term="pathname"
        
        crossorigin="anonymous"
        async
        >
</script>

<style>
    .utterances {
        max-width: unset;
    }
</style>

<script>
    let utterancesLoaded = false;

    function setUtterancesTheme(theme) {
        let utterances = document.querySelector('.utterances iframe');
        if (utterances) {
            utterances.contentWindow.postMessage(
                {
                    type: 'set-theme',
                    theme: `github-${theme}`
                },
                'https://utteranc.es'
            );
        }
    }

    addEventListener('message', event => {
        if (event.origin !== 'https://utteranc.es') return;

        
        utterancesLoaded = true;
        setUtterancesTheme(document.documentElement.dataset.scheme)
    });

    window.addEventListener('onColorSchemeChange', (e) => {
        if (!utterancesLoaded) return;
        setUtterancesTheme(e.detail)
    })
</script>


    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
        2024 Jacko John
    </section>
    
    <section class="powerby">
        使用 <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> 构建 <br />
        主题 <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.27.0">Stack</a></b> 由 <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> 设计
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
